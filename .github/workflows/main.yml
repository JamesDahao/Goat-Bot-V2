name: Node.js CI

on:
  workflow_dispatch:

permissions:
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install GitHub CLI & jq
        run: |
          if ! gh --version; then
            sudo apt-get update && sudo apt-get install gh jq -y
          else
            echo "GitHub CLI and jq already installed"
          fi

      - name: Install dependencies
        run: npm install

      - name: Start bot (5 hour)
        run: |
          echo "Running bot for 5 hour..."
          timeout 18000s npm start || echo "Bot stopped after timeout"
          echo "Bot process ended, continuing to cancel/restart steps."

      - name: Cancel previous workflow run (if exists)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for other in-progress runs..."
          RUNNING=$(gh run list --workflow="Node.js CI" --status=in_progress --limit 1 --json databaseId,url | jq -r '.[0]')
          if [ "$RUNNING" != "null" ]; then
            RUN_ID=$(echo $RUNNING | jq -r '.databaseId')
            RUN_URL=$(echo $RUNNING | jq -r '.url')
            echo "Cancelling previous run: $RUN_URL"
            gh run cancel "$RUN_ID"
          else
            echo "No other runs found."
          fi

      - name: Restart workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Restarting workflow..."
          gh workflow run "Node.js CI" --ref ${{ github.ref }}
