name: Node.js CI

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.x

      - name: Install GitHub CLI & jq
        run: |
          sudo apt-get update
          sudo apt-get install gh jq -y

      - name: Install dependencies
        run: npm install

      - name: Start bot (5 hours)
        run: |
          echo "Running bot for 5 hours..."
          timeout 18000s npm start || true
          echo "Bot stopped after 5 hours."

      - name: Cancel other in-progress runs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Checking for other running workflows..."

          RUN_ID=$(gh run list \
            --workflow="${{ github.workflow }}" \
            --status=in_progress \
            --json databaseId \
            --jq '.[0].databaseId')

          if [ -n "$RUN_ID" ]; then
            echo "Cancelling run ID: $RUN_ID"
            gh run cancel "$RUN_ID" || true
          else
            echo "No other runs found."
          fi

      - name: Wait before restart
        run: |
          echo "Waiting 60 seconds..."
          sleep 60

      - name: Restart workflow
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Restarting workflow..."
          gh workflow run "${{ github.workflow }}" --ref "${{ github.ref }}"
